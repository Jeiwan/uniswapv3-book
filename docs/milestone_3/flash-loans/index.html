<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Flash Loans #  Both Uniswap V2 and V3 implement flash loans: unlimited and uncollateralized loans that must be repaid in the same transaction. Pools basically give users arbitrary amounts of tokens that they request, but, by the end of the call, the amounts must be repaid, with a small fee on top.
The fact that flash loans must be repaid in the same transaction means that flash loans cannot be taken by regular users: as a user, you cannot program custom logic in transactions."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Flash Loans"><meta property="og:description" content="Flash Loans #  Both Uniswap V2 and V3 implement flash loans: unlimited and uncollateralized loans that must be repaid in the same transaction. Pools basically give users arbitrary amounts of tokens that they request, but, by the end of the call, the amounts must be repaid, with a small fee on top.
The fact that flash loans must be repaid in the same transaction means that flash loans cannot be taken by regular users: as a user, you cannot program custom logic in transactions."><meta property="og:type" content="article"><meta property="og:url" content="https://uniswapv3book.com/docs/milestone_3/flash-loans/"><meta property="article:section" content="docs"><title>Flash Loans | Uniswap V3 Development Book</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.c6d751c04f26429e63e616288f237ef9cf8d60f97312c98c5af2fd77071a7ffe.js integrity="sha256-xtdRwE8mQp5j5hYojyN++c+NYPlzEsmMWvL9dwcaf/4=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Uniswap V3 Development Book</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Milestone 0. Introduction</span><ul><li><a href=/docs/introduction/introduction-to-markets/>Introduction to Markets</a></li><li><a href=/docs/introduction/constant-function-market-maker/>Constant Function Market Makers</a></li><li><a href=/docs/introduction/uniswap-v3/>Uniswap V3</a></li><li><a href=/docs/introduction/dev-environment/>Development Environment</a></li><li><a href=/docs/introduction/what-we-will-build/>What We'll Build</a></li></ul></li><li class=book-section-flat><span>Milestone 1. First Swap</span><ul><li><a href=/docs/milestone_1/introduction/>Introduction</a></li><li><a href=/docs/milestone_1/calculating-liquidity/>Calculating Liquidity</a></li><li><a href=/docs/milestone_1/providing-liquidity/>Providing Liquidity</a></li><li><a href=/docs/milestone_1/first-swap/>First Swap</a></li><li><a href=/docs/milestone_1/manager-contract/>Manager Contract</a></li><li><a href=/docs/milestone_1/deployment/>Deployment</a></li><li><a href=/docs/milestone_1/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 2. Second Swap</span><ul><li><a href=/docs/milestone_2/introduction/>Introduction</a></li><li><a href=/docs/milestone_2/output-amount-calculation/>Output Amount Calculation</a></li><li><a href=/docs/milestone_2/math-in-solidity/>Math in Solidity</a></li><li><a href=/docs/milestone_2/tick-bitmap-index/>Tick Bitmap Index</a></li><li><a href=/docs/milestone_2/generalize-minting/>Generalize Minting</a></li><li><a href=/docs/milestone_2/generalize-swapping/>Generalize Swapping</a></li><li><a href=/docs/milestone_2/quoter-contract/>Quoter Contract</a></li><li><a href=/docs/milestone_2/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 3. Cross-tick Swaps</span><ul><li><a href=/docs/milestone_3/introduction/>Introduction</a></li><li><a href=/docs/milestone_3/different-ranges/>Different Price Ranges</a></li><li><a href=/docs/milestone_3/cross-tick-swaps/>Cross-Tick Swaps</a></li><li><a href=/docs/milestone_3/slippage-protection/>Slippage Protection</a></li><li><a href=/docs/milestone_3/liquidity-calculation/>Liquidity Calculation</a></li><li><a href=/docs/milestone_3/more-on-fixed-point-numbers/>A Little Bit More on Fixed-point Numbers</a></li><li><a href=/docs/milestone_3/flash-loans/ class=active>Flash Loans</a></li><li><a href=/docs/milestone_3/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 4. Multi-pool Swaps</span><ul><li><a href=/docs/milestone_4/introduction/>Introduction</a></li><li><a href=/docs/milestone_4/factory-contract/>Factory Contract</a></li><li><a href=/docs/milestone_4/path/>Swap Path</a></li><li><a href=/docs/milestone_4/multi-pool-swaps/>Multi-pool Swaps</a></li><li><a href=/docs/milestone_4/user-interface/>User Interface</a></li><li><a href=/docs/milestone_4/tick-rounding/>Tick Rounding</a></li></ul></li><li class=book-section-flat><span>Milestone 5. Fees and Price Oracle</span><ul><li><a href=/docs/milestone_5/introduction/>Introduction</a></li><li><a href=/docs/milestone_5/swap-fees/>Swap Fees</a></li><li><a href=/docs/milestone_5/flash-loan-fees/>Flash Loan Fees</a></li><li><a href=/docs/milestone_5/protocol-fees/>Protocol Fees</a></li><li><a href=/docs/milestone_5/price-oracle/>Price Oracle</a></li><li><a href=/docs/milestone_5/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 6: NFT positions</span><ul><li><a href=/docs/milestone_6/introduction/>Introduction</a></li><li><a href=/docs/milestone_6/erc721-overview/>ERC721 Overview</a></li><li><a href=/docs/milestone_6/nft-manager/>NFT Manager</a></li><li><a href=/docs/milestone_6/nft-renderer/>NFT Renderer</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Flash Loans</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#flash-loans>Flash Loans</a><ul><li><a href=#implementing-flash-loans>Implementing Flash Loans</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h2 id=flash-loans>Flash Loans
<a class=anchor href=#flash-loans>#</a></h2><p>Both Uniswap V2 and V3 implement flash loans: unlimited and uncollateralized loans that must be repaid in the same
transaction. Pools basically give users arbitrary amounts of tokens that they request, but, by the end of
the call, the amounts must be repaid, with a small fee on top.</p><p>The fact that flash loans must be repaid in the same transaction means that flash loans cannot be taken by regular users:
as a user, you cannot program custom logic in transactions. Flash loans can only be taken and repaid by smart contracts.</p><p>Flash loans is a powerful financial instrument in DeFi. While it&rsquo;s often used to exploit vulnerabilities in DeFi
protocols (by inflating pool balances and abusing flawed state management), it&rsquo;s has many good applications (e.g.
leveraged positions management on lending protocols)–this is why DeFi applications that store liquidity provide
permissionless flash loans.</p><h3 id=implementing-flash-loans>Implementing Flash Loans
<a class=anchor href=#implementing-flash-loans>#</a></h3><p>In Uniswap V2 flash loans were part of the swapping functionality: it was possible to borrow tokens during a swap, but
you had to return them or an equal amount of the other pool token, in the same transaction. In V3, flash loans are
separated from swapping–it&rsquo;s simply a function that gives the caller an amount of tokens they requested, calls a callback
on the caller, and ensures a flash loan was repaid:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>flash</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint256</span> amount0,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint256</span> amount1,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bytes</span> calldata data
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint256</span> balance0Before <span style=color:#f92672>=</span> IERC20(token0).balanceOf(<span style=color:#66d9ef>address</span>(this));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint256</span> balance1Before <span style=color:#f92672>=</span> IERC20(token1).balanceOf(<span style=color:#66d9ef>address</span>(this));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (amount0 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) IERC20(token0).transfer(msg.sender, amount0);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (amount1 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) IERC20(token1).transfer(msg.sender, amount1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IUniswapV3FlashCallback(msg.sender).uniswapV3FlashCallback(data);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    require(IERC20(token0).balanceOf(<span style=color:#66d9ef>address</span>(this)) <span style=color:#f92672>&gt;=</span> balance0Before);
</span></span><span style=display:flex><span>    require(IERC20(token1).balanceOf(<span style=color:#66d9ef>address</span>(this)) <span style=color:#f92672>&gt;=</span> balance1Before);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    emit Flash(msg.sender, amount0, amount1);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The function sends tokens to the caller and then calls <code>uniswapV3FlashCallback</code> on it–this is where the caller is expected
to repay the loan. Then the function ensures that its balances haven&rsquo;t decreased. Notice that custom data is allowed
to be passed to the callback.</p><p>Here&rsquo;s an example of the callback implementation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>uniswapV3FlashCallback</span>(<span style=color:#66d9ef>bytes</span> calldata data) <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>uint256</span> amount0, <span style=color:#66d9ef>uint256</span> amount1) <span style=color:#f92672>=</span> abi.decode(
</span></span><span style=display:flex><span>        data,
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>uint256</span>, <span style=color:#66d9ef>uint256</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (amount0 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) token0.transfer(msg.sender, amount0);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (amount1 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) token1.transfer(msg.sender, amount1);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In this implementation, we&rsquo;re simply sending tokens back to the pool (I used this callback in <code>flash</code> function tests).
In reality, it can use the loaned amounts to perform some operations on other DeFi protocols. But it always must repay
the loan in this callback.</p><p>And that&rsquo;s it!</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#flash-loans>Flash Loans</a><ul><li><a href=#implementing-flash-loans>Implementing Flash Loans</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>