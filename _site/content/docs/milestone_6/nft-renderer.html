<h1 id="nft-renderer">NFT Renderer</h1>

<p>Now we need to build an NFT renderer: a library that will handle calls to <code class="language-plaintext highlighter-rouge">tokenURI</code> in the NFT manager contract. It
will render JSON metadata and SVG for each minted token. As we discussed earlier, we’ll use the data URI syntax, which
requires base64 encoding–this means we’ll need a base64 encoder in Solidity. But first, let’s look at how our tokens
will look like.</p>

<h2 id="svg-template">SVG Template</h2>

<p>I built this simplified variation of the Uniswap V3 NFTs:</p>

<p><img src="/images/milestone_6_nft_template.png" alt="SVG template for NFT tokens" /></p>

<p>This is what its code looks like;</p>
<pre><code class="language-svg">&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 480"&gt;
  &lt;style&gt;
    .tokens {
      font: bold 30px sans-serif;
    }

    .fee {
      font: normal 26px sans-serif;
    }

    .tick {
      font: normal 18px sans-serif;
    }
  &lt;/style&gt;

  &lt;rect width="300" height="480" fill="hsl(330,40%,40%)" /&gt;
  &lt;rect x="30" y="30" width="240" height="420" rx="15" ry="15" fill="hsl(330,90%,50%)" stroke="#000" /&gt;

  &lt;rect x="30" y="87" width="240" height="42" /&gt;
  &lt;text x="39" y="120" class="tokens" fill="#fff"&gt;
    WETH/USDC
  &lt;/text&gt;

  &lt;rect x="30" y="132" width="240" height="30" /&gt;
  &lt;text x="39" y="120" dy="36" class="fee" fill="#fff"&gt;
    0.05%
  &lt;/text&gt;

  &lt;rect x="30" y="342" width="240" height="24" /&gt;
  &lt;text x="39" y="360" class="tick" fill="#fff"&gt;
    Lower tick: 123456
  &lt;/text&gt;

  &lt;rect x="30" y="372" width="240" height="24" /&gt;
  &lt;text x="39" y="360" dy="30" class="tick" fill="#fff"&gt;
    Upper tick: 123456
  &lt;/text&gt;
&lt;/svg&gt;
</code></pre>

<p>This is a simple SVG template, and we’re going to make a Solidity contract that fills the fields in this template and
returns it in <code class="language-plaintext highlighter-rouge">tokenURI</code>. The fields that will be filled uniquely for each token:</p>
<ol>
  <li>the color of the background, which is set in the first two <code class="language-plaintext highlighter-rouge">rect</code>s; the hue component (330 in the template) will be
unique for each token;</li>
  <li>the names of the tokens of a pool the position is added to (WETH/USDC in the template);</li>
  <li>the fee of a pool (0.05%);</li>
  <li>tick values of the boundaries of the position (123456).</li>
</ol>

<p>Here are examples of NFTs our contract will be able to produce:</p>

<p><img src="/images/milestone_6_nft_example_2.png" alt="NFT example 1" />
<img src="/images/milestone_6_nft_example_3.png" alt="NFT example 2" /></p>

<h2 id="dependencies">Dependencies</h2>

<p>Solidity doesn’t provide native base64 encoding tool so we’ll use a third-party one. Specifically, we’ll use <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Base64.sol">the one from OpenZeppelin</a>.</p>

<p>Another tedious thing about Solidity is that is has very poor support for operations with strings. For example, there’s
no way to convert integers to strings–but we need that to render pool fee and position ticks in the SVG template. We’ll
use <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Strings.sol">the Strings library from OpenZeppelin</a>
to do that.</p>

<h2 id="format-of-the-result">Format of the Result</h2>

<p>The data produced by the renderer will have this format:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data:application/json;base64,BASE64_ENCODED_JSON
</code></pre></div></div>

<p>The JSON will look like that:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Uniswap V3 Position"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"USDC/DAI 0.05%, Lower tick: -520, Upper text: 490"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BASE64_ENCODED_SVG"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And image will be the above template filled with position data and encoded in base64.</p>

<h2 id="implementing-the-renderer">Implementing the Renderer</h2>

<p>We’ll implement the renderer in a separate library contract to not make the NFT manager contract too noisy:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">library</span> <span class="n">NFTRenderer</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">RenderParams</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">pool</span><span class="p">;</span>
        <span class="kt">address</span> <span class="n">owner</span><span class="p">;</span>
        <span class="kt">int24</span> <span class="n">lowerTick</span><span class="p">;</span>
        <span class="kt">int24</span> <span class="n">upperTick</span><span class="p">;</span>
        <span class="kt">uint24</span> <span class="n">fee</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">render</span><span class="p">(</span><span class="n">RenderParams</span> <span class="k">memory</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">render</code> function, we’ll first render an SVG, then the JSON metadata. For the sake of cleaner code, we’ll break
down each step into smaller steps.</p>

<p>We begin with fetching tokens symbols:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">render</span><span class="p">(</span><span class="n">RenderParams</span> <span class="k">memory</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">IUniswapV3Pool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">IUniswapV3Pool</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">pool</span><span class="p">);</span>
    <span class="n">IERC20</span> <span class="n">token0</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">pool</span><span class="p">.</span><span class="n">token0</span><span class="p">());</span>
    <span class="n">IERC20</span> <span class="n">token1</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">pool</span><span class="p">.</span><span class="n">token1</span><span class="p">());</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol0</span> <span class="o">=</span> <span class="n">token0</span><span class="p">.</span><span class="n">symbol</span><span class="p">();</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol1</span> <span class="o">=</span> <span class="n">token1</span><span class="p">.</span><span class="n">symbol</span><span class="p">();</span>

    <span class="p">...</span>
</code></pre></div></div>

<h3 id="svg-rendering">SVG Rendering</h3>

<p>Then we can render the SVG template:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="k">memory</span> <span class="n">image</span> <span class="o">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="s">"&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 480'&gt;"</span><span class="p">,</span>
    <span class="s">"&lt;style&gt;.tokens { font: bold 30px sans-serif; }"</span><span class="p">,</span>
    <span class="s">".fee { font: normal 26px sans-serif; }"</span><span class="p">,</span>
    <span class="s">".tick { font: normal 18px sans-serif; }&lt;/style&gt;"</span><span class="p">,</span>
    <span class="n">renderBackground</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">lowerTick</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">upperTick</span><span class="p">),</span>
    <span class="n">renderTop</span><span class="p">(</span><span class="n">symbol0</span><span class="p">,</span> <span class="n">symbol1</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">fee</span><span class="p">),</span>
    <span class="n">renderBottom</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">lowerTick</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">upperTick</span><span class="p">),</span>
    <span class="s">"&lt;/svg&gt;"</span>
<span class="p">);</span>
</code></pre></div></div>

<p>The template is broken down into multiple steps:</p>
<ol>
  <li>first comes the header, which includes the CSS styles;</li>
  <li>then the background is rendered;</li>
  <li>then the top position information is rendered (token symbols and fee);</li>
  <li>finally, the bottom information is rendered (position ticks).</li>
</ol>

<p>The background is simply two <code class="language-plaintext highlighter-rouge">rect</code>s. To render them we need to find the unique hue of this token and then we concatenate
all the pieces together:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">renderBackground</span><span class="p">(</span>
    <span class="kt">address</span> <span class="n">owner</span><span class="p">,</span>
    <span class="kt">int24</span> <span class="n">lowerTick</span><span class="p">,</span>
    <span class="kt">int24</span> <span class="n">upperTick</span>
<span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">background</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bytes32</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodePacked</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">lowerTick</span><span class="p">,</span> <span class="n">upperTick</span><span class="p">));</span>
    <span class="kt">uint256</span> <span class="n">hue</span> <span class="o">=</span> <span class="kt">uint256</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">;</span>

    <span class="n">background</span> <span class="o">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="s">'&lt;rect width="300" height="480" fill="hsl('</span><span class="p">,</span>
        <span class="n">Strings</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span>
        <span class="s">',40%,40%)"/&gt;'</span><span class="p">,</span>
        <span class="s">'&lt;rect x="30" y="30" width="240" height="420" rx="15" ry="15" fill="hsl('</span><span class="p">,</span>
        <span class="n">Strings</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span>
        <span class="s">',100%,50%)" stroke="#000"/&gt;'</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The top template renders token symbols and pool fee:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">renderTop</span><span class="p">(</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol0</span><span class="p">,</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol1</span><span class="p">,</span>
    <span class="kt">uint24</span> <span class="n">fee</span>
<span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">top</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">top</span> <span class="o">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="s">'&lt;rect x="30" y="87" width="240" height="42"/&gt;'</span><span class="p">,</span>
        <span class="s">'&lt;text x="39" y="120" class="tokens" fill="#fff"&gt;'</span><span class="p">,</span>
        <span class="n">symbol0</span><span class="p">,</span>
        <span class="s">"/"</span><span class="p">,</span>
        <span class="n">symbol1</span><span class="p">,</span>
        <span class="s">"&lt;/text&gt;"</span>
        <span class="s">'&lt;rect x="30" y="132" width="240" height="30"/&gt;'</span><span class="p">,</span>
        <span class="s">'&lt;text x="39" y="120" dy="36" class="fee" fill="#fff"&gt;'</span><span class="p">,</span>
        <span class="n">feeToText</span><span class="p">(</span><span class="n">fee</span><span class="p">),</span>
        <span class="s">"&lt;/text&gt;"</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Fees are rendered as numbers with a fractional part. Since all possible fees are known in advance we don’t need to
convert integers to fractional numbers and can simply hardcode the values:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">feeToText</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">fee</span><span class="p">)</span>
    <span class="k">internal</span>
    <span class="k">pure</span>
    <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">feeString</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fee</span> <span class="o">==</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">feeString</span> <span class="o">=</span> <span class="s">"0.05%"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fee</span> <span class="o">==</span> <span class="mi">3000</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">feeString</span> <span class="o">=</span> <span class="s">"0.3%"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the bottom part we render position ticks:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">renderBottom</span><span class="p">(</span><span class="kt">int24</span> <span class="n">lowerTick</span><span class="p">,</span> <span class="kt">int24</span> <span class="n">upperTick</span><span class="p">)</span>
    <span class="k">internal</span>
    <span class="k">pure</span>
    <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">bottom</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="s">'&lt;rect x="30" y="342" width="240" height="24"/&gt;'</span><span class="p">,</span>
        <span class="s">'&lt;text x="39" y="360" class="tick" fill="#fff"&gt;Lower tick: '</span><span class="p">,</span>
        <span class="n">tickToText</span><span class="p">(</span><span class="n">lowerTick</span><span class="p">),</span>
        <span class="s">"&lt;/text&gt;"</span><span class="p">,</span>
        <span class="s">'&lt;rect x="30" y="372" width="240" height="24"/&gt;'</span><span class="p">,</span>
        <span class="s">'&lt;text x="39" y="360" dy="30" class="tick" fill="#fff"&gt;Upper tick: '</span><span class="p">,</span>
        <span class="n">tickToText</span><span class="p">(</span><span class="n">upperTick</span><span class="p">),</span>
        <span class="s">"&lt;/text&gt;"</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Since ticks can be positive and negative, we nee to render them properly (with or without the minus sign):</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">tickToText</span><span class="p">(</span><span class="kt">int24</span> <span class="n">tick</span><span class="p">)</span>
    <span class="k">internal</span>
    <span class="k">pure</span>
    <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">tickString</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">tickString</span> <span class="o">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">tick</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"-"</span> <span class="o">:</span> <span class="s">""</span><span class="p">,</span>
        <span class="n">tick</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="o">?</span> <span class="n">Strings</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="kt">uint24</span><span class="p">(</span><span class="o">-</span><span class="n">tick</span><span class="p">)))</span>
            <span class="o">:</span> <span class="n">Strings</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="kt">uint24</span><span class="p">(</span><span class="n">tick</span><span class="p">)))</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="json-rendering">JSON Rendering</h3>

<p>Now, let’s return to the <code class="language-plaintext highlighter-rouge">render</code> function and render the JSON. First, we need to render a token description:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">render</span><span class="p">(</span><span class="n">RenderParams</span> <span class="k">memory</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span> <span class="n">SVG</span> <span class="n">rendering</span> <span class="p">...</span>

    <span class="kt">string</span> <span class="k">memory</span> <span class="n">description</span> <span class="o">=</span> <span class="n">renderDescription</span><span class="p">(</span>
        <span class="n">symbol0</span><span class="p">,</span>
        <span class="n">symbol1</span><span class="p">,</span>
        <span class="n">params</span><span class="p">.</span><span class="n">fee</span><span class="p">,</span>
        <span class="n">params</span><span class="p">.</span><span class="n">lowerTick</span><span class="p">,</span>
        <span class="n">params</span><span class="p">.</span><span class="n">upperTick</span>
    <span class="p">);</span>

    <span class="p">...</span>
</code></pre></div></div>

<p>Token description is a text string that contains all the same information that we render in token’s SVG:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">renderDescription</span><span class="p">(</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol0</span><span class="p">,</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol1</span><span class="p">,</span>
    <span class="kt">uint24</span> <span class="n">fee</span><span class="p">,</span>
    <span class="kt">int24</span> <span class="n">lowerTick</span><span class="p">,</span>
    <span class="kt">int24</span> <span class="n">upperTick</span>
<span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">description</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">description</span> <span class="o">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">symbol0</span><span class="p">,</span>
        <span class="s">"/"</span><span class="p">,</span>
        <span class="n">symbol1</span><span class="p">,</span>
        <span class="s">" "</span><span class="p">,</span>
        <span class="n">feeToText</span><span class="p">(</span><span class="n">fee</span><span class="p">),</span>
        <span class="s">", Lower tick: "</span><span class="p">,</span>
        <span class="n">tickToText</span><span class="p">(</span><span class="n">lowerTick</span><span class="p">),</span>
        <span class="s">", Upper text: "</span><span class="p">,</span>
        <span class="n">tickToText</span><span class="p">(</span><span class="n">upperTick</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can now assemble the JSON metadata:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">render</span><span class="p">(</span><span class="n">RenderParams</span> <span class="k">memory</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">image</span> <span class="o">=</span> <span class="p">...</span><span class="n">SVG</span> <span class="n">rendering</span><span class="p">...</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">description</span> <span class="o">=</span> <span class="p">...</span><span class="n">description</span> <span class="n">rendering</span><span class="p">...</span>

    <span class="kt">string</span> <span class="k">memory</span> <span class="n">json</span> <span class="o">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="s">'{"name":"Uniswap V3 Position",'</span><span class="p">,</span>
        <span class="s">'"description":"'</span><span class="p">,</span>
        <span class="n">description</span><span class="p">,</span>
        <span class="s">'",'</span><span class="p">,</span>
        <span class="s">'"image":"data:image/svg+xml;base64,'</span><span class="p">,</span>
        <span class="n">Base64</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="kt">bytes</span><span class="p">(</span><span class="n">image</span><span class="p">)),</span>
        <span class="s">'"}'</span>
    <span class="p">);</span>
</code></pre></div></div>

<p>And, finally, we can return the result:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span>
    <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="s">"data:application/json;base64,"</span><span class="p">,</span>
        <span class="n">Base64</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="kt">bytes</span><span class="p">(</span><span class="n">json</span><span class="p">))</span>
    <span class="p">);</span>
</code></pre></div></div>

<h3 id="filling-the-gap-in-tokenuri">Filling the Gap in <code class="language-plaintext highlighter-rouge">tokenURI</code></h3>

<p>Now we’re ready to return to the <code class="language-plaintext highlighter-rouge">tokenURI</code> function in the NFT manager contract and add actual rendering:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">tokenURI</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">tokenId</span><span class="p">)</span>
    <span class="k">public</span>
    <span class="k">view</span>
    <span class="k">override</span>
    <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TokenPosition</span> <span class="k">memory</span> <span class="n">tokenPosition</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">tokenId</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tokenPosition</span><span class="p">.</span><span class="n">pool</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0x00</span><span class="p">))</span> <span class="nb">revert</span> <span class="n">WrongToken</span><span class="p">();</span>

    <span class="n">IUniswapV3Pool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">IUniswapV3Pool</span><span class="p">(</span><span class="n">tokenPosition</span><span class="p">.</span><span class="n">pool</span><span class="p">);</span>

    <span class="k">return</span>
        <span class="n">NFTRenderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">NFTRenderer</span><span class="p">.</span><span class="n">RenderParams</span><span class="p">({</span>
                <span class="n">pool</span><span class="o">:</span> <span class="n">tokenPosition</span><span class="p">.</span><span class="n">pool</span><span class="p">,</span>
                <span class="n">owner</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span>
                <span class="n">lowerTick</span><span class="o">:</span> <span class="n">tokenPosition</span><span class="p">.</span><span class="n">lowerTick</span><span class="p">,</span>
                <span class="n">upperTick</span><span class="o">:</span> <span class="n">tokenPosition</span><span class="p">.</span><span class="n">upperTick</span><span class="p">,</span>
                <span class="n">fee</span><span class="o">:</span> <span class="n">pool</span><span class="p">.</span><span class="n">fee</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="gas-costs">Gas Costs</h1>

<p>With all its benefits, storing data on-chain has a huge disadvantage: contract deployments become very expensive. When
deploying a contract, you pay for the size of the contract, and all the strings and templates increase gas spending
significantly. This gets even worse the more advanced your SVGs are: the more there are shapes, CSS styles, animations,
etc. the more expensive it gets.</p>

<p>Keep in mind that the NFT renderer we implemented above is not gas optimized: you can see the repetitive <code class="language-plaintext highlighter-rouge">rect</code> and <code class="language-plaintext highlighter-rouge">text</code>
tag strings that can be extracted into internal functions. I sacrifices gas costs for the readability of the contract.
In real NFT projects that store all data on-chain, code readability is usually very poor due to have gas cost optimizations.</p>

<h1 id="testing">Testing</h1>

<p>The last thing I wanted to focus here is how we can test the NFT images. It’s very important to keep all changes in
NFT images tracked to ensure no change breaks rendering. For this, we need a way to test the output of <code class="language-plaintext highlighter-rouge">tokenURI</code> and
its different variations (we can even pre-render the whole collection and have tests to ensure no image get broken during
development).</p>

<p>To test the output of <code class="language-plaintext highlighter-rouge">tokenURI</code>, I added this custom assertion:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">assertTokenURI</span><span class="p">(</span>
    <span class="n">nft</span><span class="p">.</span><span class="n">tokenURI</span><span class="p">(</span><span class="n">tokenId0</span><span class="p">),</span>
    <span class="s">"tokenuri0"</span><span class="p">,</span>
    <span class="s">"invalid token URI"</span>
<span class="p">);</span>
</code></pre></div></div>

<p>The first argument is the actual output and the second argument is the name of the file that stores the expected one.
The assertion load the content of the file and compares it with the actual one:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">assertTokenURI</span><span class="p">(</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">actual</span><span class="p">,</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">expectedFixture</span><span class="p">,</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">errMessage</span>
<span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="k">memory</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">readFile</span><span class="p">(</span>
        <span class="kt">string</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="s">"./test/fixtures/"</span><span class="p">,</span> <span class="n">expectedFixture</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="n">assertEq</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">errMessage</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can do this in Solidity thanks to the <code class="language-plaintext highlighter-rouge">vm.readFile()</code> cheat code provided by <code class="language-plaintext highlighter-rouge">forge-std</code> library, which is a helper
library that comes with Forge. Not only this is simple and convenient, this is also secure: we can configure filesystem
permissions to allow only permitted file operations. Specifically, to make the above test work, we need to add this
<code class="language-plaintext highlighter-rouge">fs_permissions</code> rule to <code class="language-plaintext highlighter-rouge">foundry.toml</code>:</p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">fs_permissions</span> <span class="p">=</span> <span class="nn">[{access='read',path='.'}]</span>
</code></pre></div></div>

<p>This is how you can read the SVG from <code class="language-plaintext highlighter-rouge">tokenURI</code> output:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat test</span>/fixtures/tokenuri0 <span class="se">\</span>
    | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">','</span> <span class="s1">'{print $2}'</span> <span class="se">\</span>
    | <span class="nb">base64</span> <span class="nt">-d</span> - <span class="se">\</span>
    | jq <span class="nt">-r</span> .image <span class="se">\</span>
    | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">','</span> <span class="s1">'{print $2}'</span> <span class="se">\</span>
    | <span class="nb">base64</span> <span class="nt">-d</span> - <span class="o">&gt;</span> nft.svg <span class="se">\</span>
    <span class="o">&amp;&amp;</span> open nft.svg
</code></pre></div></div>

<blockquote>
  <p>This is the <a href="https://stedolan.github.io/jq/">jq tool</a>, a CLI JSON parser.</p>
</blockquote>
