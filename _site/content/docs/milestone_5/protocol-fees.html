
<h1 id="protocol-fees">Protocol Fees</h1>

<p>While working on the Uniswap implementation, you&#8217;ve probably asked yourself, &#8220;How does Uniswap make money?&#8221; Well, it
doesn&#8217;t (at least as of September 2022).</p>

<p>In the implementation we&#8217;ve built so far, traders pay liquidity providers for providing liquidity, and Uniswap Labs, as
the company that developed the DEX, is not part of this process. Neither traders, nor liquidity providers pay Uniswap
Labs for using the Uniswap DEX. How come?</p>

<p>In fact, there&#8217;s a way for Uniswap Labs to start making money on the DEX. However, the mechanism hasn&#8217;t been enabled yet
(again, as of September 2022). Each Uniswap pool has <em>protocol fees</em> collection mechanism. Protocol fees are collected
from swap fees: a small portion of swap fees is subtracted and saved as protocol fees to later be collected by Factory
contract owner (Uniswap Labs). The size of protocol fees is expected to be determined by UNI token holders, but it must
be between $1/4$ and $1/10$ (inclusive).</p>

<p>For brevity, we&#8217;re not going to add protocol fees to our implementation, but let&#8217;s see how they&#8217;re implemented in Uniswap.</p>

<p>Protocol fee size is stored in <code class="language-plaintext highlighter-rouge">slot0</code>:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UniswapV3Pool.sol
</span><span class="k">struct</span> <span class="n">Slot0</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// the current protocol fee as a percentage of the swap fee taken on withdrawal
</span>    <span class="c1">// represented as an integer denominator (1/x)%
</span>    <span class="kt">uint8</span> <span class="n">feeProtocol</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And we&#8217;ll also need a global accumulator to track accrued fees:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// accumulated protocol fees in token0/token1 units
</span><span class="k">struct</span> <span class="n">ProtocolFees</span> <span class="p">{</span>
    <span class="kt">uint128</span> <span class="n">token0</span><span class="p">;</span>
    <span class="kt">uint128</span> <span class="n">token1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ProtocolFees</span> <span class="k">public</span> <span class="k">override</span> <span class="n">protocolFees</span><span class="p">;</span>
</code></pre></div></div>

<p>Protocol fees can be set in <code class="language-plaintext highlighter-rouge">setFeeProtocol</code> function:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">setFeeProtocol</span><span class="p">(</span><span class="kt">uint8</span> <span class="n">feeProtocol0</span><span class="p">,</span> <span class="kt">uint8</span> <span class="n">feeProtocol1</span><span class="p">)</span> <span class="k">external</span> <span class="k">override</span> <span class="n">lock</span> <span class="n">onlyFactoryOwner</span> <span class="p">{</span>
    <span class="nb">require</span><span class="p">(</span>
        <span class="p">(</span><span class="n">feeProtocol0</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">feeProtocol0</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">feeProtocol0</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">feeProtocol1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">feeProtocol1</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">feeProtocol1</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span>
    <span class="p">);</span>
    <span class="kt">uint8</span> <span class="n">feeProtocolOld</span> <span class="o">=</span> <span class="n">slot0</span><span class="p">.</span><span class="n">feeProtocol</span><span class="p">;</span>
    <span class="n">slot0</span><span class="p">.</span><span class="n">feeProtocol</span> <span class="o">=</span> <span class="n">feeProtocol0</span> <span class="o">+</span> <span class="p">(</span><span class="n">feeProtocol1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">emit</span> <span class="n">SetFeeProtocol</span><span class="p">(</span><span class="n">feeProtocolOld</span> <span class="o">%</span> <span class="mi">16</span><span class="p">,</span> <span class="n">feeProtocolOld</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">feeProtocol0</span><span class="p">,</span> <span class="n">feeProtocol1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, it&#8217;s allowed to set protocol fees separate for each of the tokens. The values are two <code class="language-plaintext highlighter-rouge">uint8</code> that are
packed to be stored in one <code class="language-plaintext highlighter-rouge">uint8</code>: <code class="language-plaintext highlighter-rouge">feeProtocol1</code> is shifted to the left by 4 bits (this is identical to multiplying it
by 16) and added to <code class="language-plaintext highlighter-rouge">feeProtocol0</code>. To unpack <code class="language-plaintext highlighter-rouge">feeProtocol0</code>, a remainder of division <code class="language-plaintext highlighter-rouge">slot0.feeProtocol</code> by 16 is taken;
<code class="language-plaintext highlighter-rouge">feeProtocol1</code> is simply integer division of <code class="language-plaintext highlighter-rouge">slot0.feeProtocol</code>  by 4.</p>

<p>Before beginning a swap, we need to choose one of the protocol fees depending on swap direction (swap and protocol fees
are collected on input tokens):</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">swap</span><span class="p">(...)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kt">uint8</span> <span class="n">feeProtocol</span> <span class="o">=</span> <span class="n">zeroForOne</span> <span class="o">?</span> <span class="p">(</span><span class="n">slot0_</span><span class="p">.</span><span class="n">feeProtocol</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">slot0_</span><span class="p">.</span><span class="n">feeProtocol</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>To accrue protocol fees, we subtract them from swap fees right after computing swap step amounts:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">while</span> <span class="p">(...)</span> <span class="p">{</span>
    <span class="p">(...,</span> <span class="n">step</span><span class="p">.</span><span class="n">feeAmount</span><span class="p">)</span> <span class="o">=</span> <span class="n">SwapMath</span><span class="p">.</span><span class="n">computeSwapStep</span><span class="p">(...);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="n">feeProtocol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">step</span><span class="p">.</span><span class="n">feeAmount</span> <span class="o">/</span> <span class="n">cache</span><span class="p">.</span><span class="n">feeProtocol</span><span class="p">;</span>
        <span class="n">step</span><span class="p">.</span><span class="n">feeAmount</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
        <span class="n">state</span><span class="p">.</span><span class="n">protocolFee</span> <span class="o">+=</span> <span class="kt">uint128</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<p>After a swap is done, the protocol fees accumulator needs to be updated:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">zeroForOne</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">protocolFee</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token0</span> <span class="o">+=</span> <span class="n">state</span><span class="p">.</span><span class="n">protocolFee</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">protocolFee</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token1</span> <span class="o">+=</span> <span class="n">state</span><span class="p">.</span><span class="n">protocolFee</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, Factory contract owner can collect accrued protocol fees:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">collectProtocol</span><span class="p">(</span>
    <span class="kt">address</span> <span class="n">recipient</span><span class="p">,</span>
    <span class="kt">uint128</span> <span class="n">amount0Requested</span><span class="p">,</span>
    <span class="kt">uint128</span> <span class="n">amount1Requested</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">override</span> <span class="n">lock</span> <span class="n">onlyFactoryOwner</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint128</span> <span class="n">amount0</span><span class="p">,</span> <span class="kt">uint128</span> <span class="n">amount1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">amount0</span> <span class="o">=</span> <span class="n">amount0Requested</span> <span class="o">&gt;</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token0</span> <span class="o">?</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token0</span> <span class="o">:</span> <span class="n">amount0Requested</span><span class="p">;</span>
    <span class="n">amount1</span> <span class="o">=</span> <span class="n">amount1Requested</span> <span class="o">&gt;</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token1</span> <span class="o">?</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token1</span> <span class="o">:</span> <span class="n">amount1Requested</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">amount0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount0</span> <span class="o">==</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token0</span><span class="p">)</span> <span class="n">amount0</span><span class="o">--</span><span class="p">;</span>
        <span class="n">protocolFees</span><span class="p">.</span><span class="n">token0</span> <span class="o">-=</span> <span class="n">amount0</span><span class="p">;</span>
        <span class="n">TransferHelper</span><span class="p">.</span><span class="n">safeTransfer</span><span class="p">(</span><span class="n">token0</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">amount0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">amount1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount1</span> <span class="o">==</span> <span class="n">protocolFees</span><span class="p">.</span><span class="n">token1</span><span class="p">)</span> <span class="n">amount1</span><span class="o">--</span><span class="p">;</span>
        <span class="n">protocolFees</span><span class="p">.</span><span class="n">token1</span> <span class="o">-=</span> <span class="n">amount1</span><span class="p">;</span>
        <span class="n">TransferHelper</span><span class="p">.</span><span class="n">safeTransfer</span><span class="p">(</span><span class="n">token1</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">amount1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">emit</span> <span class="n">CollectProtocol</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">amount0</span><span class="p">,</span> <span class="n">amount1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
